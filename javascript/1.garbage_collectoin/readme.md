### 垃圾回收机制 (Grabage Collection)
> 名词解析

垃圾：无法再被访问的对象或者内存空间
延迟：每次GC从开始到结束的尺寸时间
吞吐量：每次GC回收的内存量

> GC 常用的算法

### 引用计数

初代的垃圾收集算法。在此把”垃圾“的定义简化为没有被引用到的。
如果没有引用指向该对象（引用数为0）,对象将被GC回收，实现方式
为给每一个对象添加一个计数器，来计算对这个对象的引用数量，当引用数
归零时候，表示该对象不被需要就可以被回收

优点：
```
1. 内存释放及时，任何一个对象引用计数为0,立即释放内存
2. 内存及时释放，不回聚集在某时间范围内
```
缺点：
```
1.每一个对象需要增加一个计数的字段
2.循环引用的的对象，会导致引用数不为零无法回收
```

### 标记清除 Mark-Sweep

除去引用计数，Mark-Sweep是另一个思考方向。它分为标记和清除两个阶段。当垃圾回收被触发时，运行时从有限的根节点（在Javascript里，根是全局对象）出发，对所有能够到达的对象进行标记（一般为深度优先搜索），然后再遍历整个堆，清除所有未被标记的对象。

优点：
```
(1)相比引用计数很难处理循环引用，Mark-Sweep算法总能找到所有无法被引用的对象
(2)由于垃圾总被一起批量回收，可能可以提高内存回收的吞吐
(3)这个算法实现起来简单
```
缺点：
```
(1)每个对象需要附带至少一个比特作为标记的空间
(2)由于Mark阶段需要在整个堆上随机遍历，对CPU缓存不友好
(3)算法的性能与堆的大小相关，当堆非常大，而单次回收对象数量有限时，性能被严重拖累
(4)垃圾回收的延迟较高，会使用户代码完全停止一段时间
(5)出现内存不连续的状态
```

### 标记复制 Mark-Copy

Mark-Copy将堆内存一分为二，一个处于使用状态，一个处于闲置状态。当开始垃圾回收时，会检查使用状态的内存块，把存活的对象复制到闲置状态的内存块，完成复制后，两个内存空间交换角色。

### 标记整理 Mark-Compact
注意Mark-Copy算法需要维护一个额外的堆来作为拷贝活对象的容器。标记整理和标记清除的差别在于对象标记死亡后，在整理内存的过程中，将活着的对象往一端移动，移动完成后，直接清理边界外的内存。

可以说Mark-Compact是Mark-Copy和Mark-Sweep算法的一种整合，其优缺点也只是前两种算法各取部分。

> V8 内存管理和垃圾回收机制

GC 算法采用了分代式垃圾回收机制。因此，V8 将内存（堆）分为新生代和老生代两部分。

### 新生代

新生代中的对象一般存活时间较短，使用 Scavenge GC 算法。

在新生代空间中，内存空间分为两部分，分别为 From 空间和 To 空间。在这两个空间中，必定有一个空间是使用的，另一个空间是空闲的。新分配的对象会被放入 From 空间中，当 From 空间被占满时，新生代 GC 就会启动了。算法会检查 From 空间中存活的对象并复制到 To 空间中，如果有失活的对象就会销毁。当复制完成后将 From 空间和 To 空间互换，这样 GC 就结束了。

### 老生代
老生代中的对象一般存活时间较长且数量也多，使用了两个算法，分别是标记清除算法和标记整理算法。

对象出现在老生代空间的情况:

1. 新生代中的变量已经经过一次Scavenage算法，会被转移到老生代空间
2. To空间的对象占比大小超过25%  

优先启动标记清除算法

1. 某一个空间没有分块的时候
2. 空间中对象超过一定的限制
3. 空间不能保证新生代对象移动到老生代中

在这个阶段中，会遍历堆中所有的对象，然后标记活的对象，在标记完成后，销毁所有没有被标记的对象。在标记大型对内存时，可能需要几百毫秒才能完成一次标记。这就会导致一些性能上的问题。为了解决这个问题，2011 年，V8 从 stop-the-world 标记切换到增量标志。在增量标记期间，GC 将标记工作分解为更小的模块，可以让 JS 应用逻辑在模块间隙执行一会，从而不至于让应用出现停顿情况。但在 2018 年，GC 技术又有了一个重大突破，这项技术名为并发标记。该技术可以让 GC 扫描和标记对象时，同时允许 JS 运行

标记清除后会造成堆内存出现碎片的情况，当碎片超过一定限制后会启动压缩算法。在压缩过程中，将活的对象像一端移动，直到所有对象都移动完成然后清理掉不需要的内存

> 内存泄露

当遇到该被回收掉的对象，因为某些原因没有被回收掉占据内存空间，我们将其称之为 ’内存泄露‘

内存泄露到一定程度超出了内存的大小限制就变成了 ’内存溢出‘，蓝屏的钙好喝的钙

### 常见引起内存泄露的方式
1. 全局变量
2. 闭包
3. dom清除时候未移除事件
4. 子元素存在引用
---
参考文档：

1. JavaScript GC:[https://www.jianshu.com/p/18532079bc2a](https://www.jianshu.com/p/18532079bc2a)

https://segmentfault.com/a/1190000018605776?utm_source=tag-newest

https://www.cnblogs.com/fanlu/p/11176319.html

https://www.jianshu.com/p/2c10e2537fda